<script type="text/javascript" src="${staticserver}/common/js/libs/jquery.json-2.4.js"></script>
<style>
	.ext-add {
		padding: 10px;
		font-size: 14px;
		margin-top: 10px;
		text-align: center;
		background: #F9F9F9;
		border: 1px solid #CCC;
	}
	
	.ext-add a {
		width: 130px;
		height: 30px;
		display: block;
		margin: 0 auto;
		line-height: 30px;
		background: url("${staticserver}/common/images/icons.png") no-repeat -21px -1449px;
	}
	.ext-add a:hover {
		background-position: -13px -1932px;
	}
	
	.operate-bar {
		width: 36px;
	    float: right;
		cursor: pointer;
		margin-top: 15px;
		margin-left: -36px;
	}
	.operate-bar a {
	    width: 30px;
	    height: 32px;
	    display: block;
	    border: 1px solid #CCCCCC;
		background: url("${staticserver}/common/images/icons.png") no-repeat;
	}
	.operate-bar a.del {
	    background-position: -20px -1555px;
	}
	.operate-bar a.del:hover {
	    background-position: -45px -1555px;
	}
	.operate-bar a.up {
	    background-position: -21px -1487px;
	}
	.operate-bar a.up:hover {
	    background-position: -46px -1487px;
	}
	.operate-bar a.down {
	    border-top: 0 none;
	    border-bottom: 0 none;
	    background-position: -21px -1521px;
	}
	.operate-bar a.down:hover {
	    background-position: -46px -1521px;
	}
</style>
<script type="text/javascript" src="../js/libs/fancybox/jquery.mousewheel-3.0.4.pack.js"></script>
<script type="text/javascript" src="../js/libs/fancybox/jquery.fancybox-1.3.4.pack.js"></script>
<link rel="stylesheet" type="text/css" href="../js/libs/fancybox/jquery.fancybox-1.3.4.css" media="screen" />
<style>
	 .attach {padding-left: 5px;}
	 .attach div {float: left;width: 50px;height: 30px;line-height: 30px;text-align: right;font-size: 14px;}
	 .attackform {margin-top: 20px;}
	 .operateReference-item { font-size: 14px;padding-left: 5px;overflow: visible;margin-bottom: 5px;margin-bottom: 0\9;}
	 .operateReference-item div { height: 24px!important; line-height: 24px!important;}
	 .operateReference-button { margin: -5px 0 5px 10px;}
	 .operateReference-list { padding-bottom: 5px;}
	 .operateReference-img { margin-bottom: -2px;margin-right: 5px; }
	 .operateReference-disabled-img { padding-left: 10px;cursor: pointer;margin-bottom: 2px;vertical-align: middle; }
	 .operateReference-span { line-height: 15px; }
	 .operateReference-span a { color : #369; }
	 .operateReference-size-span { color: gray;margin-left: 2px; }
</style>

<div class="right-title">
    <h2>项目资料</h2>
</div>
<div id="project_attachment" style="padding-top: 10px;">
	<div class="operateReference-list">
		<#list filelist as f>
		<#if f.type == "0">
		<div class="operateReference-item" fid="${f.id}" fname="${f.name}" fextend="${f.ext}" fpath="${f.addr}" fsize="${f.fsize}" ftype="${f.type}">
			<div style="float: left; width: 50px; height: 30px; line-height: 30px; text-align: right;"></div>
			<img src="${staticserver}/common/images/attachment.gif" class="operateReference-img">
			<a <#if f.ext == "jpg" || f.ext == "jpeg" || f.ext == "gif" || f.ext == "png" || f.ext == "bmp">rel="img_group"</#if> href="${fileserver}${f.addr}" title="${f.name}">${f.name}</a>
			<span class="operateReference-size-span" fsize="${f.fsize}"></span>
			<img class="operateReference-disabled-img" onclick="delAttachment($(this).closest('div'));" title="删除" src="${staticserver}/common/images/delete.gif">
		</div>
		</#if>
		</#list>
	</div>
	<form class="attackform">
	    <input type="file" name="upfile" id="upfile"/>
		<s:hidden name="catId"></s:hidden> 
		<div>                  
		<div id="fileQueue"></div>                   
		</div>
		<div class="attach clearfix">
			<div></div>
			<!--<input name="upfile" type="file" class="input" style="float: left;width: 400px;height: 26px;">-->
			<input id="projectattachment" name="#" type="button" value="上传" class="kdmall-btn upload"  style="float: left;vertical-align: top;padding: 2px 12px 2px 12px;margin-top: 1px;">
		</div>
	</form>
</div>

<div class="right-title" style="margin-top: 30px;">
    <h2>抵押资料</h2>
</div>
<div id="mortgage_project" style="padding-top: 10px;">
	<div class="operateReference-list">
		<#list filelist as f>
		<#if f.type == "1">
		<div class="operateReference-item" fid="${f.id}" fname="${f.name}" fextend="${f.ext}" fpath="${f.addr}" fsize="${f.fsize}" ftype="${f.type}">
			<div style="float: left; width: 50px; height: 30px; line-height: 30px; text-align: right;"></div>
			<img src="${staticserver}/common/images/attachment.gif" class="operateReference-img">
			<a <#if f.ext == "jpg" || f.ext == "jpeg" || f.ext == "gif" || f.ext == "png" || f.ext == "bmp">rel="img_group"</#if> href="${fileserver}${f.addr}" title="${f.name}">${f.name}</a>
			<span class="operateReference-size-span" fsize="${f.fsize}"></span>
			<img class="operateReference-disabled-img" onclick="delAttachment($(this).closest('div'));" title="删除" src="${staticserver}/common/images/delete.gif">
		</div>
		</#if>
		</#list>
	</div>
	<form class="attackform">
	    <input type="file" name="upfile" id="upfile1"/>
		<s:hidden name="catId"></s:hidden>
		<div>                  
		<div id="fileQueue1"></div>                   
		</div>
		<div class="attach clearfix">
			<div></div>
			<!--<input name="upfile" type="file" class="input" style="float: left;width: 400px;height: 26px;">-->
			<input id="mortgageproject" name="#" type="button" value="上传" class="kdmall-btn upload" style="float: left;vertical-align: top;padding: 2px 12px 2px 12px;margin-top: 1px;">
		</div>
	</form>
</div>

<script>
	var isdoing = false;
	$(function() {
		resetsn('project_attachment');
		resetsn('mortgage_project');
		$(".operateReference-size-span").each(function() {
			$(this).text(convertSize($(this).attr("fsize")));
		});
	});
	function delAttachment($obj) {
		$.kd.kdConfirm("确定要删除该文件吗？", function() {
			$obj.attr("isvalid", "N").hide();
			savefile($obj, function() {
				resetsn($obj.closest(".operateReference-list").parent().attr("id"));
			});
		});
	}
	
	function resetsn(pid) {
		$(".operateReference-item:visible", "#" + pid).each(function(i) {
			$("div", this).text((i + 1) + "、");
		});
		
		$("a:visible[rel=img_group]").fancybox({
			'titlePosition': 'over',
			'titleFormat': function(title, currentArray, currentIndex, currentOpts) {
				return '<span id="fancybox-title-over">' + (title.length ? ' &nbsp; ' + title : '') + '&nbsp;<span style="font-weight: bold;">（' + (currentIndex + 1) + ' / ' + currentArray.length + '）</span></span>';
			}
		});
	}
	
	function savefile($obj, func) {
		var info, result = [], fid;
		$obj.each(function(i) {
			fid = $(this).attr("fid");
			info = {};
			info.sn = i;
			info.id = fid ? fid : "";
			info.bid = $("#bid").val();
			info.fname = $(this).attr("fname");
			info.fextend = $(this).attr("fextend");
			info.fsize = $(this).attr("fsize");
			info.fpath = $(this).attr("fpath");
			info.ftype = $(this).attr("ftype") == "project_attachment" ? 0 : 1;
			info.isvalid = $(this).attr("isvalid");
			
			if(info.id || info.isvalid == "Y") result.push(info);
		});
		
		if(result.length > 0) $.post("mall/newbond!addFile.do?ajax=yes", {fileinfo: $.toJSON(result)}, function(data) {
			try {$obj.attr("id", eval("[" + data + "]")[0].message);
			     <!-- window.location.href="/addborrow.html?type=attachment&id="+$("#bid").val(); -->
			} catch(e){};
			func();
		});
	}
	
	function convertSize(size) {
        var unit = "B";
        
        size = parseInt(size.split(",").join(""));
        
        if (size <= 0) {     
        } else if(size < 1024) {
            unit = "B";
            decimalNum = 0;
        } else if(size < 1000 *1024) {
            unit = "KB";
            decimalNum = 0;
            size = size / 1024;
        } else {
            unit = "MB";
            size = size / (1000 * 1024);
        }
        return Math.round(size * 100) / 100 + unit;
	}
</script>
<link href="${staticserver}/common/js/uploadify/uploadify.css" rel="stylesheet"  type="text/css" />  
<script type="text/javascript" src="${staticserver}/common/js/uploadify/swfobject.js"></script>  
<script type="text/javascript" src="${staticserver}/common/js/uploadify/jquery.uploadify.js"></script>  
<script type="text/javascript">  
    $(document).ready(function() { 
	    var $submitform = "";	
        //上传图片会导致cookie中sessionid变化，故取出jsessionid保存起来，上传成功后写回
		 $("#projectattachment").click(function(){
		   $submitform = $(this).closest("form");
		   $("#mortgageproject").attr("disabled", true);
		   uploadFile();
		 });
		  $("#mortgageproject").click(function(){
		   $("#projectattachment").attr("disabled", true);
		   $submitform = $(this).closest("form");
		   uploadFile1();
		 });   
		    
			
			
			var cookies =  document.cookie.split(";");
			for (idx in cookies) {
			if ( cookies[idx].indexOf("JSESSIONID") > -1) {
				window.umesession = cookies[idx];				 
			   }
			}	
		$("#upfile").uploadify({  
            'swf' : '${staticserver}/common/js/uploadify/uploadify.swf', //是组件自带的flash，用于打开选取本地文件的按钮  
            'script' : '${fileserver}/file!upload.do',//处理上传的路径，这里使用Struts2是XXX.action  
            'uploader' : '${fileserver}/file!upload.do',
            'scriptData' :{'catId':$('#catId').val()},  
          /*   'cancelImg' : '${staticserver}/common/js/uploadify/uploadify-cancel.png',//取消上传文件的按钮图片，就是个叉叉   */
            'folder' : '${fileserver}',//上传文件的目录  
            'fileObjName' : 'upfile',//和input的name属性值保持一致就好，Struts2就能处理了  
            'queueID' : 'fileQueue',  
            'auto' : false,//是否选取文件后自动上传  
            'multi' : true,//是否支持多文件上传  
            'simUploadLimit' : 6,//每次最大上传文件数  
            'queueSizeLimit' : 50,  
            'removeCompleted' : true,  
            'buttonText' : '上传文件',//按钮上的文字  
            'displayData' : 'percentage',//有speed和percentage两种，一个显示速度，一个显示完成百分比  
            'fileTypeDesc' : '支持格式:jpg/gif/jpeg/png/bmp.', //如果配置了以下的'fileExt'属性，那么这个属性是必须的  
            'fileTypeExts' : '*.jpg;*.gif;*.jpeg;*.png;*.bmp',//允许的格式  
            'onUploadSuccess' : function(file,data,response) {  
                //$("#result").html(response);//显示上传成功结果  
                //setInterval("showResult()", 2000);//两秒后删除显示的上传成功结果
				document.cookie = window.umesession;
				var json = eval('(' + data + ')');
					if(json.result == 0) {
						$.kd.kdAlert("上传资料失败！");
					} else{
					   var extend = json.name.substr(json.name.lastIndexOf(".") + 1);
						var $file = $(
							'<div class="operateReference-item" fname="' + json.name + '" fextend="' + extend + '" fpath="' + json.message + '" fsize="' + json.size + '" ftype="' + $submitform.parent().attr("id") + '" isvalid="Y">'+
						    	'<div style="float: left;width: 50px;height: 30px;line-height: 30px;text-align: right;">' + ($(".operateReference-item:visible", $submitform.parent()).size() + 1) + '、</div>'+
						    	'<img src="${staticserver}/common/images/attachment.gif" class="operateReference-img"/>'+
						    	'<a rel="img_group" href="${fileserver}' + json.message + '" title="' + json.name + '">' + json.name + '</a>'+
						    	'<span class="operateReference-size-span" fsize="' + json.size + '">' + convertSize(json.size) + '</span>'+
					    		'<img class="operateReference-disabled-img" onclick="delAttachment($(this).closest(\'div\'));" title="删除" src="${staticserver}/common/images/delete.gif">'+
						    '</div>'
						);
						$(".operateReference-list", $submitform.parent()).append($file);
						
						savefile($file, function() {
							resetsn($submitform.parent().attr("id"));
						});
						
						$("input[type=file]", $submitform).val("");
						isdoing = false;
						$("#mortgageproject").attr("disabled", false);
					}
                				
               //console.log(data);//上传成功后跳转，并传递参数  
            }  
        }); 
		
		$("#upfile1").uploadify({  
            'swf' : '${staticserver}/common/js/uploadify/uploadify.swf', //是组件自带的flash，用于打开选取本地文件的按钮  
            'script' : '${fileserver}/file!upload.do',//处理上传的路径，这里使用Struts2是XXX.action  
            'uploader' : '${fileserver}/file!upload.do',
            'scriptData' :{'catId':$('#catId').val()},  
          /*   'cancelImg' : '${staticserver}/common/js/uploadify/uploadify-cancel.png',//取消上传文件的按钮图片，就是个叉叉   */
            'folder' : '${fileserver}',//上传文件的目录  
            'fileObjName' : 'upfile',//和input的name属性值保持一致就好，Struts2就能处理了  
            'queueID' : 'fileQueue1',  
            'auto' : false,//是否选取文件后自动上传  
            'multi' : true,//是否支持多文件上传  
            'simUploadLimit' : 6,//每次最大上传文件数  
            'queueSizeLimit' : 50,  
            'removeCompleted' : true,  
            'buttonText' : '上传文件',//按钮上的文字  
            'displayData' : 'percentage',//有speed和percentage两种，一个显示速度，一个显示完成百分比  
            'fileTypeDesc' : '支持格式:jpg/gif/jpeg/png/bmp.', //如果配置了以下的'fileExt'属性，那么这个属性是必须的  
            'fileTypeExts' : '*.jpg;*.gif;*.jpeg;*.png;*.bmp',//允许的格式  
            'onUploadSuccess' : function(file,data,response) {  
                //$("#result").html(response);//显示上传成功结果  
                //setInterval("showResult()", 2000);//两秒后删除显示的上传成功结果
				document.cookie = window.umesession;
				var json = eval('(' + data + ')');
					if(json.result == 0) {
						$.kd.kdAlert("上传资料失败！");
					} else{
					   var extend = json.name.substr(json.name.lastIndexOf(".") + 1);
						var $file = $(
							'<div class="operateReference-item" fname="' + json.name + '" fextend="' + extend + '" fpath="' + json.message + '" fsize="' + json.size + '" ftype="' + $submitform.parent().attr("id") + '" isvalid="Y">'+
						    	'<div style="float: left;width: 50px;height: 30px;line-height: 30px;text-align: right;">' + ($(".operateReference-item:visible", $submitform.parent()).size() + 1) + '、</div>'+
						    	'<img src="${staticserver}/common/images/attachment.gif" class="operateReference-img"/>'+
						    	'<a rel="img_group" href="${fileserver}' + json.message + '" title="' + json.name + '">' + json.name + '</a>'+
						    	'<span class="operateReference-size-span" fsize="' + json.size + '">' + convertSize(json.size) + '</span>'+
					    		'<img class="operateReference-disabled-img" onclick="delAttachment($(this).closest(\'div\'));" title="删除" src="${staticserver}/common/images/delete.gif">'+
						    '</div>'
						);
						$(".operateReference-list", $submitform.parent()).append($file);
						
						savefile($file, function() {
							resetsn($submitform.parent().attr("id"));
						});
						
						$("input[type=file]", $submitform).val("");
						isdoing = false;
						$("#projectattachment").attr("disabled", false);
					}
                				
               //console.log(data);//上传成功后跳转，并传递参数  
            }  
        }); 
    });  
  
    //function showResult() {//删除显示的上传成功结果  
    //  $("#result").html("");  
    //}  
    function uploadFile() {//上传文件 
	    
        $("#upfile").uploadify('upload','*'); 
    }
   function uploadFile1() {//上传文件 
	    
        $("#upfile1").uploadify('upload','*'); 
    }  	
    function clearFile() {//清空所有上传队列  
        $("#upfile").uploadifyClearQueue();  
    }  
</script>
